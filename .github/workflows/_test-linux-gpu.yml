# Linux GPU test workflow (self-hosted) - called by test-matrix.yml
name: Test Linux GPU

on:
  workflow_call:
    inputs:
      config-file:
        type: string
        default: "comfy-test.toml"
      timeout-minutes:
        type: number
        default: 1440

jobs:
  linux-gpu-test:
    name: linux-gpu-test
    runs-on: ["self-hosted", "linux", "gpu"]
    timeout-minutes: ${{ inputs.timeout-minutes }}
    env:
      PYTHONUNBUFFERED: "1"
      PYTHONFAULTHANDLER: "1"
      PW_TEST_SCREENSHOT_NO_FONTS_READY: "1"
      COMFY_ENV_DEBUG: "1"
      COMFY_TEST_GPU: "1"
      COMFY_TEST_LOGS_DIR: ${{ github.workspace }}/comfy-test-logs
      COMFY_TEST_WORKSPACE_DIR: ${{ github.workspace }}/test_workspaces
      NODE_NAME: ${{ github.event.repository.name }}
      COMFYUI_DIR: ${{ github.workspace }}/ComfyUI
      PYTHON_DIR: ${{ github.workspace }}/python
      PYTHON_EXE: ${{ github.workspace }}/python/bin/python3
      PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/python/.playwright
      COMFY_ENV_CACHE_DIR: /home/administrator/.comfy-env
      HF_HOME: /mnt/c/Users/Administrator/.cache/huggingface
    steps:
      # --- Check if passing results already exist for this commit ---
      - name: Check for existing results
        id: check-existing
        run: |
          BRANCH="${GITHUB_REF_NAME}"
          REPO="${GITHUB_REPOSITORY}"
          URL="https://raw.githubusercontent.com/${REPO}/gh-pages/${BRANCH}/linux-gpu/results.json"

          echo "Checking: $URL"
          HTTP_CODE=$(curl -s -o /tmp/results.json -w "%{http_code}" "$URL" 2>/dev/null || echo "000")

          if [ "$HTTP_CODE" = "200" ]; then
            EXISTING_HASH=$(python3 -c "import json; d=json.load(open('/tmp/results.json')); print(d.get('commit_hash', ''))" 2>/dev/null || echo "")
            EXISTING_SUCCESS=$(python3 -c "import json; d=json.load(open('/tmp/results.json')); print(str(d.get('success', False)).lower())" 2>/dev/null || echo "false")

            echo "Existing commit_hash: $EXISTING_HASH"
            echo "Existing success: $EXISTING_SUCCESS"
            echo "Current SHA: $GITHUB_SHA"

            if [ "$EXISTING_HASH" = "$GITHUB_SHA" ] && [ "$EXISTING_SUCCESS" = "true" ]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "SKIPPING: linux-gpu results already passing for this commit"
            else
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "Results exist but commit hash or success differs, re-running"
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "No existing results found (HTTP $HTTP_CODE), running tests"
          fi

      - name: Tests skipped (results already published)
        if: steps.check-existing.outputs.skip == 'true'
        run: echo "Skipped linux-gpu tests - passing results already exist for commit $GITHUB_SHA"

      - name: Acquire platform lock
        if: steps.check-existing.outputs.skip != 'true'
        run: |
          echo "Waiting for linux-gpu lock..."
          while ! mkdir /mnt/c/linux-gpu-lock 2>/dev/null; do
            sleep 10
          done
          echo "Platform lock acquired"
          touch "$RUNNER_TEMP/platform-lock-acquired"

      - name: Cleanup stale mounts
        if: steps.check-existing.outputs.skip != 'true'
        run: |
          sudo umount "${{ github.workspace }}/python" 2>/dev/null || true
          sudo umount "${{ github.workspace }}/ComfyUI" 2>/dev/null || true

      - name: Set cache directory
        if: steps.check-existing.outputs.skip != 'true'
        run: echo "LOCAL_CACHE_DIR=$RUNNER_TOOL_CACHE/comfy-test-cache/linux-gpu-v3" >> $GITHUB_ENV

      - uses: astral-sh/setup-uv@v4
        if: steps.check-existing.outputs.skip != 'true'

      # --- Restore local cache (overlayfs: instant, cache stays read-only) ---
      - name: Restore local cache
        if: steps.check-existing.outputs.skip != 'true'
        id: local-cache
        run: |
          if [ -d "$LOCAL_CACHE_DIR" ]; then
            echo "Restoring from local cache (overlayfs)..."
            OVL="/tmp/ovl-${GITHUB_RUN_ID}"
            mkdir -p "$PYTHON_DIR" "$COMFYUI_DIR"
            mkdir -p "$OVL/python-upper" "$OVL/python-work"
            mkdir -p "$OVL/comfy-upper" "$OVL/comfy-work"
            sudo mount -t overlay overlay -o lowerdir="$LOCAL_CACHE_DIR/python",upperdir="$OVL/python-upper",workdir="$OVL/python-work" "$PYTHON_DIR"
            sudo mount -t overlay overlay -o lowerdir="$LOCAL_CACHE_DIR/ComfyUI",upperdir="$OVL/comfy-upper",workdir="$OVL/comfy-work" "$COMFYUI_DIR"
            # Pre-create bin/ in upper layer so uv's relative path traversal
            # (site-packages/../../../bin/) triggers proper overlayfs copy-up
            mkdir -p "$OVL/python-upper/bin"
            echo "OVL_DIR=$OVL" >> $GITHUB_ENV
            echo "Cache mounted!"
            echo "cache-hit=true" >> $GITHUB_OUTPUT
          else
            echo "No local cache found"
            echo "cache-hit=false" >> $GITHUB_OUTPUT
          fi

      # --- Setup (skip if cache hit) ---
      - name: Setup environment
        if: steps.check-existing.outputs.skip != 'true' && steps.local-cache.outputs.cache-hit != 'true'
        run: |
          # Download standalone Python (python-build-standalone)
          echo "Downloading Python..."
          curl -L -o python.tar.gz "https://github.com/indygreg/python-build-standalone/releases/download/20250106/cpython-3.13.1+20250106-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz"
          tar xzf python.tar.gz
          rm python.tar.gz

          # Clone ComfyUI
          git clone --depth 1 https://github.com/comfyanonymous/ComfyUI.git $COMFYUI_DIR

          # Patch requirements.txt to remove torch/torchvision/torchaudio (we install CUDA versions separately)
          sed -i -E '/^(torch|torchvision|torchaudio)$/d' $COMFYUI_DIR/requirements.txt

          # Install CUDA torch
          uv pip install --python "$PYTHON_EXE" torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu130

          # Install ComfyUI requirements
          uv pip install --python "$PYTHON_EXE" -r $COMFYUI_DIR/requirements.txt

          # Install playwright
          uv pip install --python "$PYTHON_EXE" playwright
          $PYTHON_EXE -m playwright install chromium
          $PYTHON_EXE -m playwright install-deps chromium || true

      # --- Save local cache immediately after setup ---
      - name: Save local cache
        if: steps.check-existing.outputs.skip != 'true' && steps.local-cache.outputs.cache-hit != 'true'
        run: |
          echo "Saving to local cache..."
          mkdir -p "$LOCAL_CACHE_DIR"
          (echo "  Saving python..." && cp -a "$PYTHON_DIR/." "$LOCAL_CACHE_DIR/python/" && echo "  python done") &
          (echo "  Saving ComfyUI..." && cp -a "$COMFYUI_DIR/." "$LOCAL_CACHE_DIR/ComfyUI/" && echo "  ComfyUI done") &
          wait
          echo "Cache saved!"

      # --- Verify CUDA torch ---
      - name: Verify CUDA torch
        if: steps.check-existing.outputs.skip != 'true'
        run: |
          echo "Verifying CUDA torch installation..."
          $PYTHON_EXE -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA version: {torch.version.cuda}'); print(f'Device: {torch.cuda.get_device_name(0) if torch.cuda.is_available() else \"N/A\"}')"

      # --- Install comfy-test (fresh) ---
      - name: Install comfy-test
        if: steps.check-existing.outputs.skip != 'true'
        run: |
          VERSION=$(echo "$GITHUB_WORKFLOW_REF" | grep -oP '(?<=@refs/tags/v)[^/]+' || echo "")
          if [ -n "$VERSION" ]; then
            uv pip install --python "$PYTHON_EXE" "comfy-test==$VERSION"
          else
            uv pip install --python "$PYTHON_EXE" comfy-test
          fi

      # --- Checkout and run ---
      - uses: actions/checkout@v4
        if: steps.check-existing.outputs.skip != 'true'
        with:
          path: ${{ env.COMFYUI_DIR }}/custom_nodes/${{ github.event.repository.name }}

      - name: Install node dependencies
        if: steps.check-existing.outputs.skip != 'true'
        working-directory: ${{ env.COMFYUI_DIR }}/custom_nodes/${{ env.NODE_NAME }}
        run: |
          [ -f requirements.txt ] && uv pip install --python "$PYTHON_EXE" -r requirements.txt || true
          [ -f install.py ] && $PYTHON_EXE install.py || true

      - name: Install validate endpoint
        if: steps.check-existing.outputs.skip != 'true'
        run: |
          git clone --depth 1 https://github.com/PozzettiAndrea/ComfyUI-validate-endpoint.git "$COMFYUI_DIR/custom_nodes/ComfyUI-validate-endpoint" || true

      - name: Acquire GPU lock
        if: steps.check-existing.outputs.skip != 'true'
        run: |
          echo "Waiting for GPU lock..."
          while ! mkdir /mnt/c/gpu-lock 2>/dev/null; do
            sleep 10
          done
          echo "GPU lock acquired"
          touch "$RUNNER_TEMP/gpu-lock-acquired"

      - name: Run tests
        if: steps.check-existing.outputs.skip != 'true'
        working-directory: ${{ env.COMFYUI_DIR }}/custom_nodes/${{ env.NODE_NAME }}
        run: |
          mkdir -p "$COMFY_TEST_LOGS_DIR"

          # Kill any stale process on port 8388 from a previous job
          if fuser 8388/tcp 2>/dev/null; then
            echo "Killing stale process on port 8388..."
            fuser -k 8388/tcp 2>/dev/null || true
            sleep 2
          fi

          echo "Starting GPU server..."
          $PYTHON_EXE -u "$COMFYUI_DIR/main.py" --listen 127.0.0.1 --port 8388 &
          SERVER_PID=$!

          echo "Waiting for server (up to 5 minutes)..."
          SERVER_READY=0
          for i in $(seq 1 300); do
            if ! kill -0 $SERVER_PID 2>/dev/null; then
              echo "Server process died!"
              exit 1
            fi
            if curl -s http://127.0.0.1:8388/system_stats > /dev/null 2>&1; then
              echo "Server is ready after $i seconds!"
              SERVER_READY=1
              break
            fi
            sleep 1
          done

          if [ "$SERVER_READY" != "1" ]; then
            echo "Server failed to start within 5 minutes"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          xvfb-run --auto-servernum $PYTHON_EXE -m comfy_test run --server-url http://127.0.0.1:8388
          TEST_EXIT_CODE=$?

          kill $SERVER_PID 2>/dev/null || true
          # Belt and suspenders: kill anything still on port 8388
          fuser -k 8388/tcp 2>/dev/null || true
          sleep 2
          exit $TEST_EXIT_CODE

      - name: Release GPU lock
        if: always() && steps.check-existing.outputs.skip != 'true'
        run: |
          if [ -f "$RUNNER_TEMP/gpu-lock-acquired" ]; then
            rmdir /mnt/c/gpu-lock 2>/dev/null || true
          fi

      - uses: actions/upload-artifact@v4
        if: always() && steps.check-existing.outputs.skip != 'true'
        with:
          name: results-linux-gpu
          path: |
            ${{ env.COMFY_TEST_LOGS_DIR }}/
          if-no-files-found: ignore
          include-hidden-files: true

      # --- Cleanup (unmount overlays, then wipe workspace) ---
      - name: Cleanup workspace
        if: always() && steps.check-existing.outputs.skip != 'true'
        run: |
          sudo umount "$PYTHON_DIR" 2>/dev/null || true
          sudo umount "$COMFYUI_DIR" 2>/dev/null || true
          rm -rf "$OVL_DIR" 2>/dev/null || true
          rm -rf "$GITHUB_WORKSPACE"/* || true
          rm -rf "$GITHUB_WORKSPACE"/.* 2>/dev/null || true

      - name: Release platform lock
        if: always() && steps.check-existing.outputs.skip != 'true'
        run: |
          if [ -f "$RUNNER_TEMP/platform-lock-acquired" ]; then
            rmdir /mnt/c/linux-gpu-lock 2>/dev/null || true
          fi
