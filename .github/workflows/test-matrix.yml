name: ComfyUI Installation Test Matrix

on:
  workflow_call:
    inputs:
      node-path:
        description: "Path to custom node directory"
        type: string
        default: "."
      config-file:
        description: "Path to comfy-test.toml config file"
        type: string
        default: "comfy-test.toml"
      python-version:
        description: "Python version for testing"
        type: string
        default: "3.10"
      comfy-test-ref:
        description: "Git ref for comfy-test (branch, tag, or SHA)"
        type: string
        default: "main"
      timeout-minutes:
        description: "Job timeout in minutes (default: 60)"
        type: number
        default: 60

jobs:
  test-linux:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      - name: Checkout node
        uses: actions/checkout@v4

      - name: Checkout comfy-test
        uses: actions/checkout@v4
        with:
          repository: PozzettiAndrea/comfy-test
          ref: ${{ inputs.comfy-test-ref }}
          path: .comfy-test-src

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        run: pip install uv

      - name: Install comfy-test
        run: pip install ./.comfy-test-src

      - name: Run installation test
        run: comfy-test run --platform linux --config ${{ inputs.config-file }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-linux
          path: .comfy-test/
          if-no-files-found: ignore

  test-windows:
    runs-on: windows-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      - name: Checkout node
        uses: actions/checkout@v4

      - name: Checkout comfy-test
        uses: actions/checkout@v4
        with:
          repository: PozzettiAndrea/comfy-test
          ref: ${{ inputs.comfy-test-ref }}
          path: .comfy-test-src

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install uv
        run: pip install uv

      - name: Install comfy-test
        run: pip install ./.comfy-test-src

      - name: Run installation test
        run: comfy-test run --platform windows --config ${{ inputs.config-file }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-windows
          path: .comfy-test/
          if-no-files-found: ignore

  test-windows-portable:
    runs-on: windows-latest
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      - name: Checkout node
        uses: actions/checkout@v4

      - name: Checkout comfy-test
        uses: actions/checkout@v4
        with:
          repository: PozzettiAndrea/comfy-test
          ref: ${{ inputs.comfy-test-ref }}
          path: .comfy-test-src

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install comfy-test
        run: pip install ./.comfy-test-src

      - name: Run installation test
        run: comfy-test run --platform windows-portable --config ${{ inputs.config-file }}

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-windows-portable
          path: .comfy-test/
          if-no-files-found: ignore
