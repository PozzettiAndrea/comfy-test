# =============================================================================
# PR Gate and Promote
# =============================================================================
# Consumer repos call this workflow:
#   uses: PozzettiAndrea/comfy-test/.github/workflows/pr-gate.yml@main
#
# Handles two events:
#   - pull_request: verifies test workflow passed for the PR HEAD commit
#   - push (after merge): promotes gh-pages results from dev to main
# =============================================================================

name: PR Gate and Promote

on:
  workflow_call:
    inputs:
      test-workflow-name:
        description: "Name of the test workflow to verify passed"
        type: string
        default: "Workflow Tests"

jobs:
  # ---------------------------------------------------------------------------
  # PR check: verify tests passed for the PR HEAD commit
  # ---------------------------------------------------------------------------
  check-tests:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Verify tests passed for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request.head.sha;
            const branch = context.payload.pull_request.head.ref;
            const workflowName = "${{ inputs.test-workflow-name }}";
            core.info(`Checking "${workflowName}" results for commit ${sha.substring(0, 7)}`);

            // Check HEAD commit first
            const { data } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: sha,
            });

            const testRuns = data.workflow_runs.filter(
              r => r.name === workflowName
            );

            // Only consider runs that actually completed or are actively running
            const completedRuns = testRuns.filter(r => r.status === "completed");
            let run = completedRuns.length > 0 ? completedRuns[0] : null;

            // If no completed run for HEAD (skipped or stuck in waiting/queued),
            // find the last completed run on this branch.
            if (!run) {
              if (testRuns.length > 0) {
                core.info(`Run exists for HEAD but status is "${testRuns[0].status}" — falling back to last completed run`);
              }
              core.info(`No run for HEAD commit — checking recent runs on branch "${branch}"...`);
              const { data: branchRuns } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branch,
                per_page: 10,
              });

              const branchTestRuns = branchRuns.workflow_runs.filter(
                r => r.name === workflowName && r.status === "completed"
              );

              if (branchTestRuns.length === 0) {
                core.setFailed(
                  `No "${workflowName}" run found for commit ${sha.substring(0, 7)} ` +
                  `or any recent commit on branch "${branch}". Push to dev and run tests first.`
                );
                return;
              }

              run = branchTestRuns[0];
              core.info(`Using most recent completed run from commit ${run.head_sha.substring(0, 7)}`);
            }

            core.info(`Run: ${run.html_url}`);
            core.info(`Conclusion: ${run.conclusion}`);

            if (run.conclusion !== "success") {
              core.setFailed(
                `Tests did not pass (${run.conclusion}). ` +
                `Fix failures on dev first.`
              );
              return;
            }

            core.info("Tests passed. PR is safe to merge.");

  # ---------------------------------------------------------------------------
  # Promote: copy gh-pages dev results to main after merge
  # ---------------------------------------------------------------------------
  promote:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install comfy-test==0.2.6

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1

      - name: Copy dev results to main
        run: |
          rm -rf gh-pages/main
          cp -r gh-pages/dev gh-pages/main

      - name: Regenerate indexes
        run: |
          comfy-test generate-index gh-pages/main --repo-name "${{ github.repository }}"
          comfy-test generate-root-index gh-pages --repo-name "${{ github.repository }}"

      # --- Screenshot gallery for README ---
      - name: Find screenshot platform
        id: find-platform
        run: |
          for dir in windows-portable-cpu windows-portable-gpu windows-cpu windows-gpu linux-gpu linux-cpu; do
            if [ -f "gh-pages/main/$dir/index.html" ]; then
              echo "platform=$dir" >> "$GITHUB_OUTPUT"
              echo "Found screenshot platform: $dir"
              exit 0
            fi
          done
          echo "platform=" >> "$GITHUB_OUTPUT"
          echo "No screenshot platform found, skipping"

      - name: Screenshot gallery
        if: steps.find-platform.outputs.platform != ''
        uses: Shresht7/web-screenshot-action@v1
        with:
          url: file://${{ github.workspace }}/gh-pages/main/${{ steps.find-platform.outputs.platform }}/index.html
          path: gh-pages/gallery-preview.png
          width: 1200
          height: 700

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages
          keep_files: true
