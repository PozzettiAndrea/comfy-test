# =============================================================================
# PR Gate and Promote
# =============================================================================
# Consumer repos call this workflow:
#   uses: PozzettiAndrea/comfy-test/.github/workflows/pr-gate.yml@main
#
# Handles two events:
#   - pull_request: verifies test workflow passed for the PR HEAD commit
#   - push (after merge): promotes gh-pages results from dev to main
# =============================================================================

name: PR Gate and Promote

on:
  workflow_call:
    inputs:
      test-workflow-name:
        description: "Name of the test workflow to verify passed"
        type: string
        default: "Workflow Tests"

jobs:
  # ---------------------------------------------------------------------------
  # PR check: verify tests passed for the PR HEAD commit
  # ---------------------------------------------------------------------------
  check-tests:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Verify tests passed for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.payload.pull_request.head.sha;
            const workflowName = "${{ inputs.test-workflow-name }}";
            core.info(`Checking "${workflowName}" results for commit ${sha.substring(0, 7)}`);

            const { data } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: sha,
            });

            const testRuns = data.workflow_runs.filter(
              r => r.name === workflowName
            );

            if (testRuns.length === 0) {
              core.setFailed(
                `No "${workflowName}" run found for commit ${sha.substring(0, 7)}. ` +
                `Push to dev and run tests first.`
              );
              return;
            }

            const latest = testRuns[0];
            core.info(`Run: ${latest.html_url}`);
            core.info(`Status: ${latest.status}, Conclusion: ${latest.conclusion}`);

            if (latest.status !== "completed") {
              core.setFailed(
                `Tests still running (${latest.status}). ` +
                `Wait for completion then re-run this check.`
              );
              return;
            }

            if (latest.conclusion !== "success") {
              core.setFailed(
                `Tests did not pass (${latest.conclusion}). ` +
                `Fix failures on dev first.`
              );
              return;
            }

            core.info("Tests passed. PR is safe to merge.");

  # ---------------------------------------------------------------------------
  # Promote: copy gh-pages dev results to main after merge
  # ---------------------------------------------------------------------------
  promote:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install comfy-test

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1

      - name: Copy dev results to main
        run: |
          rm -rf gh-pages/main
          cp -r gh-pages/dev gh-pages/main

      - name: Regenerate indexes
        run: |
          comfy-test generate-index gh-pages/main --repo-name "${{ github.repository }}"
          comfy-test generate-root-index gh-pages --repo-name "${{ github.repository }}"

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: gh-pages
          keep_files: true
